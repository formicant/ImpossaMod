    MODULE Code


        DISP #C000

; Copied to RAM page 1 #C000
p_c000:  ; #c000
        dh 80 2C 30 2D 30 2C 30 31
        dh 30 2C 30 2D 30 2C 30 25
        dh 30 FF 7F 30 FF 80 91 1C
        dh 30 92 20 30 1F 30 22 30
        dh 20 30 93 23 30 22 30 94
        dh 27 30 90 FF 81 01 18 01
        dh 18 FF 81 01 18 01 18 01
        dh 18 01 18 01 18 01 18 01
        dh 0C 01 0C 01 0C 01 0C 01
        dh 18 01 18 01 18 01 18 01
        dh 18 01 18 01 0C 01 0C 01
        dh 0C 01 0C FF 82 12 06 36
        dh 06 1E 06 2A 06 12 06 36
        dh 06 1E 06 2A 06 12 06 36
        dh 06 1E 06 2A 06 12 06 36
        dh 06 1E 06 2A 06 12 06 36
        dh 06 1E 06 2A 06 12 06 36
        dh 06 1E 06 2A 06 12 06 36
        dh 06 1E 06 2A 06 12 06 36
        dh 06 1E 06 2A 06 12 06 36
        dh 06 1E 06 2A 06 12 06 36
        dh 06 1E 06 2A 06 12 06 36
        dh 06 1E 06 2A 06 12 06 36
        dh 06 1E 06 2A 06 12 06 36
        dh 06 1E 06 2A 06 12 06 36
        dh 06 1E 06 12 06 12 06 12
        dh 06 12 0C 12 0C 12 06 12
        dh 06 FF 81 91 23 12 23 12
        dh 23 12 92 27 12 27 0C 27
        dh 0C 29 12 29 12 29 12 22
        dh 12 22 0C 22 0C 90 FF 81
        dh 0D 06 0D 06 0D 0C 0D 0C
        dh 0D 06 0D 0C 0D 0C 0D 06
        dh 08 0C 0B 0C FF 81 10 06
        dh 10 06 10 0C 10 0C 10 06
        dh 10 06 0B 06 0B 06 0B 0C
        dh 0B 0C 0B 06 0B 06 FF 81
        dh 0D 06 19 0C 0D 06 19 0C
        dh 0D 06 19 0C 0D 06 19 0C
        dh 0B 0C 08 0C FF 81 0D 06
        dh 0D 06 0D 0C 0D 12 0D 0C
        dh 0D 06 0D 0C 0D 0C 19 06
        dh 19 06 FF 81 10 06 10 06
        dh 10 0C 10 0C 10 06 10 06
        dh 0B 06 0B 06 0B 0C 0B 0C
        dh 0B 06 0B 06 FF 81 0D 06
        dh 0D 06 19 0C 0D 0C 19 06
        dh 0D 0C 0D 06 19 0C 0D 0C
        dh 19 0C 09 06 09 06 15 0C
        dh 09 0C 15 06 0B 0C 0B 06
        dh 17 0C 0B 0C 17 0C 0D 06
        dh 0D 06 19 0C 0D 0C 19 06
        dh 0D 0C 0D 06 19 0C 0D 0C
        dh 19 0C 10 06 10 06 1C 0C
        dh 10 0C 1C 06 0B 0C 0B 06
        dh 17 0C 0B 0C 17 0C FF 81
        dh 0D 06 0D 0C 0D 06 0D 0C
        dh 0D 06 0D 12 0B 0C 10 0C
        dh 0B 0C 09 06 09 0C 09 0C
        dh 09 0C 09 06 0B 0C 08 0C
        dh 0B 0C 0D 0C FF 83 2A 0C
        dh 2A 0C 1E 0C 2A 0C 2A 06
        dh 2A 0C 2A 06 1E 0C 1E 0C
        dh 2A 0C 2A 0C 1E 12 2A 0C
        dh 2A 06 2A 06 2A 06 1E 06
        dh 12 06 06 06 06 06 06 0C
        dh 06 0C 2A 0C 1E 0C 1E 0C
        dh 2A 0C 1E 0C 2A 0C 1E 0C
        dh 1E 0C 2A 0C 2A 06 2A 06
        dh 2A 06 36 06 36 06 2A 06
        dh 1E 06 12 06 06 06 06 06
        dh FF 84 19 0C 20 06 20 06
        dh 1F 0C 20 0C 25 0C 24 0C
        dh 25 0C 27 0C 19 0C 21 06
        dh 21 06 20 0C 21 0C 23 0C
        dh 21 0C 20 0C 1C 0C 19 0C
        dh 20 06 20 06 1F 0C 20 0C
        dh 25 0C 24 0C 25 0C 27 0C
        dh 28 0C 2A 06 2C 06 2D 0C
        dh 2C 06 2A 06 2C 0C 2A 0C
        dh 28 0C 27 0C FF 84 25 0C
        dh 20 0C 25 0C 2C 0C 28 18
        dh 27 18 25 0C 20 0C 25 0C
        dh 2C 0C 28 0C 27 0C 25 0C
        dh 23 0C 25 0C 20 0C 25 0C
        dh 2C 0C 28 18 27 0C 23 0C
        dh 21 30 20 30 FF 84 25 78
        dh 28 06 27 06 28 06 27 06
        dh 28 0C 2A 0C 28 0C 23 0C
        dh 25 78 28 06 27 06 28 06
        dh 27 06 28 0C 2A 0C 28 0C
        dh 29 0C FF 80 2A 78 2D 06
        dh 2C 06 2D 06 2C 06 2D 0C
        dh 2F 0C 2D 0C 28 0C 2A 60
        dh 85 2A 60 FF 84 14 0C 17
        dh 0C 16 0C 17 0C 14 0C 23
        dh 0C 22 0C 20 0C 1B 0C 1E
        dh 0C 1D 0C 1E 0C 1B 0C 2A
        dh 0C 29 0C 27 0C 1E 0C 21
        dh 0C 20 0C 21 0C 1E 0C 2D
        dh 0C 2C 0C 2A 0C 34 0C 33
        dh 0C 31 0C 28 0C 27 0C 25
        dh 0C 1C 0C 1B 0C FF 84 14
        dh 0C 17 0C 16 0C 17 0C 14
        dh 0C 23 0C 22 0C 20 0C 1B
        dh 0C 1E 0C 1D 0C 1E 0C 1B
        dh 0C 2A 0C 29 0C 27 0C 1E
        dh 0C 21 0C 20 0C 21 0C 1E
        dh 0C 2D 0C 2C 0C 2A 0C 22
        dh 0C 25 0C 24 0C 25 0C 22
        dh 0C 25 0C 28 0C 2B 0C FF
        dh 84 94 2C 0C 2C 18 2D 18
        dh 2C 18 2A 0C 2C 60 90 86
        dh 01 03 FF 7F 60 7F 60 7F
        dh 60 7F 60 FF 84 17 60 85
        dh 17 60 7F 60 7F 60 FF 82
        dh 12 60 12 60 12 60 12 06
        dh 12 06 12 06 12 06 12 06
        dh 12 06 12 06 12 06 12 06
        dh 12 06 12 06 12 06 12 06
        dh 12 06 12 06 12 06 FF 81
        dh 0D 0C 0D 0C 0D 0C 0D 0C
        dh 0D 0C 0D 0C 0D 0C 0D 0C
        dh 0D 0C 0D 0C 0D 0C 0D 0C
        dh 0D 0C 0D 06 0D 06 0D 0C
        dh 0D 06 0D 06 0D 0C 0D 0C
        dh 0D 0C 0D 0C 0D 0C 0D 0C
        dh 0D 0C 0D 0C 0D 06 0D 06
        dh 0D 0C 0D 0C 0D 06 0D 0C
        dh 0D 06 0D 06 0D 06 0D 0C
        dh 0D 06 0D 06 FF 81 14 06
        dh 14 06 14 0C 14 12 14 0C
        dh 14 06 14 0C 14 0C 14 06
        dh 14 06 0F 06 0F 06 0F 0C
        dh 0F 0C 0F 06 0F 0C 0F 0C
        dh 0F 06 0F 0C 0F 06 0F 06
        dh 12 06 12 06 12 0C 12 12
        dh 12 0C 12 06 12 0C 12 0C
        dh 12 06 12 06 0D 06 0D 06
        dh 0D 0C 0D 12 0D 0C 0D 06
        dh 0D 0C 0D 0C 0D 06 0D 06
        dh FF 81 14 06 14 06 14 0C
        dh 14 12 14 0C 14 06 14 0C
        dh 14 0C 14 06 14 06 0F 06
        dh 0F 06 0F 0C 0F 0C 0F 06
        dh 0F 0C 0F 0C 0F 06 0F 0C
        dh 0F 06 0F 06 12 06 12 06
        dh 12 0C 12 12 12 0C 12 06
        dh 12 0C 12 0C 12 06 12 06
        dh 16 06 0A 06 0A 0C 0A 12
        dh 0A 0C 0A 06 0A 0C 0A 0C
        dh 0A 06 0A 06 FF 81 08 0C
        dh 08 18 09 18 08 18 06 0C
        dh 08 60 FF

; used in playMenuMusic
p_c4cb:
        dh D7 C4 02 C5 0A C5
        dh 1E C5 1E C5 1E C5
p_c4d7:
        dh 88 03 04 1A 83 07
        dh 08 09 FE
        dh F9 09 FE 00 09 FE F9 09
        dh FE 00 83 0A 0B 0C 82 0D
        dh 0C 83 0A 0B 0C 82 0D 0C
        dh 0C FE 05 0C FE 00 1B 1C
        dh 1D FF 00 02 FE 05 02 8E
        dh 05 FF 16 16 19 17 82 06
        dh 0E 0F 10 16 0E 0F 10 10
        dh 11 12 13 14 15 FF 01 FF
        dh 00 12 15 2C 32 5C DA F7
        dh 0D 27 3D 53 6D BF E5 39
        dh 85 B5 DB F4 36 78 8B 94
        dh 9F 9F C7 15 69 BD C0 C0
        dh C0 C0 C0 C0 C0 C0 C1 C1
        dh C1 C1 C1 C1 C1 C2 C2 C2
        dh C2 C2 C3 C3 C3 C3 C3 C3
        dh C3 C4 C4 C4 8A 21 49 00
        dh 00 00 00 00 8A 19 41 00
        dh 00 00 00 00 8A 29 49 00
        dh 00 00 00 00 8A 21 39 00
        dh 00 00 00 00 A1 31 00 00
        dh 00 00 00 00 60 FF 30 FF
        dh 30 10 06 01 00 01 7F FD
        dh 00 FE 37 00 00 00 00 01
        dh 7F FA 00 FF 28 00 01 18
        dh 00 02 7F FC 00 FF 28 00
        dh 01 18 00 02 7F FE 32 FF
        dh 3E 20 03 02 00 01 7F FF
        dh 32 FF 40 00 00 01 00 01
        dh 7F FE 00 FF 00 20 03 02
        dh 00 01 60 FF 00 FF 30 10
        dh 06 01 00 01

; AY sound effects (15 × 13 bytes)
aySounds:  ; #c5d4
        ;                                 l  h  c
        dh 7F E9 01 FF 7F 00 00 A3 00 01 DA 05 01
        dh 1B FF 01 FF 50 00 00 01 00 01 2F 00 01
        dh 7F E9 01 FF 7F 00 00 29 FF 01 4E 03 01
        dh 08 F2 01 F9 6B FF 00 00 00 05 3C 0F 02
        dh 0E F2 01 F9 29 FF 00 00 00 02 58 00 01
        dh 7F FC 01 FF 44 00 00 EC FF 01 6A 08 01
        dh 7F FD 01 FF 60 00 00 00 FF 02 F0 00 01
        dh 0C 00 00 00 71 00 00 9C 00 05 BB 0F 0F
        dh 0A FA 01 F6 00 00 00 FF FF 05 23 00 1C
        dh 14 EC 01 FF 7F 01 00 00 00 02 7C 00 0A
        dh 7F FD 01 FF 7F 04 00 E0 FF 01 6D 09 01
        dh 7F FA 01 FF 7F 00 00 F2 FF 01 7D 02 01
        dh 7F F6 01 FF 7F 00 00 00 00 01 84 0D 01
        dh 7F F9 01 FF 7F 00 00 00 00 01 C8 00 01
        dh 7F FD 08 DD 7E 00 00 DD FC 01 F2 03 01


p_c697:  ; #c697
        dh EE 0E 18 0E 4D
        dh 0D 8E 0C DA 0B 2F 0B 8F
        dh 0A F7 09 68 09 E1 08 61
        dh 08 E9 07 77 07 0C 07 A7
        dh 06 47 06 ED 05 98 05 47
        dh 05 FC 04 D4 04 70 04 31
        dh 04 F4 03 DC 03 86 03 53
        dh 03 24 03 F6 02 CC 02 A4
        dh 02 7E 02 5A 02 38 02 18
        dh 02 FA 01 DE 01 C3 01 AA
        dh 01 92 01 7B 01 66 01 52
        dh 01 3F 01 2D 01 1C 01 0C
        dh 01 FD 00 EF 00 E1 00 D5
        dh 00 C9 00 BE 00 B3 00 A9
        dh 00 9F 00 96 00 8E 00 86
        dh 00 7F 00 77 00 71 00 6A
        dh 00 64 00 5F 00 59 00 54
        dh 00 50 00 4B 00 47 00 43
        dh 00 3F 00 3C 00 38 00 35
        dh 00 32 00 2F 00 2D 00 2A
        dh 00 28 00 26 00 24 00 22
        dh 00 20 00 18 00


mixerValue:  ; #c741
        db AY.mixOff


; #c742
;           _  _  _  l  h     c  5 *6 =0 =0  7  8  l  h yl yh  9
;           0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17
ayChA:  dh FE F7 09 6D 6F 6E 74 79 0D 0A 09 6C 64 20 63 2C 28 69
ayChB:  dh FD EF 12 70 74 78 73 69 7A 65 29 0D 0A 09 6C 64 20 62
ayChC:  dh FB DF 24 0A 09 61 64 64 20 68 6C 2C 62 63 09 3B 6D 6F
; relative displacements:
dPerL   EQU  3
dPerH   EQU  4
dVol    EQU  5

dChB    EQU 18
dChC    EQU 36


p_c778:  ; #c778
        db 0


; (some subroutine?)
; Used by p_cb0c and p_cd25.
p_c779:  ; #c779
        di
        ld a, iyl
        ld (ix + 15), a
        ld a, iyh
        ld (ix + 16), a
        ld (ix + 3), l
        ld (ix + 4), h
        ld (ix + 6), c
        ld a, (iy + 5)
        ld (ix + 7), a
        ld a, (iy + 6)
        and #7F
        srl a
        jr NZ, .l_0
        ld a, 1
.l_0:
        ld (ix + 8), a
        ld a, (iy + 7)
        ld (ix + 11), a
        ld a, (iy + 8)
        ld (ix + 12), a
        xor a
        ld (ix + 9), a
        ld (ix + 10), a
        ld a, (mixerValue)
        or (ix + 2)
        ld c, (iy + 9)
        ld (ix + 17), c
        bit 0, c
        jr Z, .l_1
        and (ix)
.l_1:
        bit 1, c
        jr Z, .l_2
        and (ix + 1)
.l_2:
        ld (mixerValue), a
        bit 2, c
        jr NZ, .l_3
        
        ld hl, p_c92d
        ld (ix + 13), l
        ld (ix + 14), h
        ret

.l_3:
        ; set envelope
        call doNothing
        ld a, (iy + 0)
        ld c, AY.regEnvShape
        call setAyReg
        ld a, (iy + 4)
        ld c, AY.regEnvPer
        call setAyReg
        inc c
        xor a
        call setAyReg
        ld (ix + 5), #FF
        jp justReturn


; Initializes AY registers and some variables
initAy:  ; #c7fe
        call doNothing
        
        ld c, AY.regMixer
        ld a, (mixerValue)
        or AY.mixOff
        ld (mixerValue), a
        call setAyReg
        xor a
        inc c                   ; regVolumeA
        call setAyReg
        inc c                   ; regVolumeB
        call setAyReg
        inc c                   ; regVolumeC
        call setAyReg
        ld a, 1
        inc c                   ; regEnvPer (low)
        call setAyReg
        inc c                   ; regEnvPer (high)
        xor a
        call setAyReg
        inc c                   ; regEnvShape
        call setAyReg
        
        ld (ayChA + 17), a
        ld (ayChB + 17), a
        ld (ayChC + 17), a
        ld (ayChA + 5), a
        ld (ayChB + 5), a
        ld (ayChC + 5), a
        
        jp justReturn


; Writes values to AY registers
; Used by p_cb0c.
setAyValues:  ; #c83f
        ld a, (mixerValue)
        and AY.mixOff
        cp AY.mixOff
        ret Z
        
        ld ix, ayChA
        call p_c8fb
        ld ix, ayChB
        call p_c8fb
        ld ix, ayChC
        call p_c8fb
        
        call doNothing
        ld ix, ayChA
        
        ; regMixer
        ld c, AY.regMixer
        ld a, (mixerValue)
        call setAyReg
        
        ; regPeriodA
        ld c, AY.regPeriodA
        ld a, (ayChA + dPerL)
        add a, (ix + 9)
        bit 1, (ix + 17)
        jp Z, .l_0
        ld (p_c778), a
.l_0:
        call setAyReg
        inc c
        ld a, (ayChA + dPerH)
        adc a, (ix + 10)
        call setAyReg
        
        ; regPeriodB
        inc c
        ld a, (ayChB + dPerL)
        add a, (ix + dChB + 9)
        bit 1, (ix + dChB + 17)
        jp Z, .l_1
        ld (p_c778), a
.l_1:
        call setAyReg
        inc c
        ld a, (ayChB + dPerH)
        adc a, (ix + dChB + 10)
        call setAyReg
        
        ; regPeriodC
        inc c
        ld a, (ayChC + dPerL)
        add a, (ix + dChC + 9)
        bit 1, (ix + dChC + 17)
        jp Z, .l_2
        ld (p_c778), a
.l_2:
        call setAyReg
        inc c
        ld a, (ayChC + dPerH)
        adc a, (ix + dChC + 10)
        call setAyReg
        
        ; regNoisePer
        inc c
        ld a, (p_c778)
   .3   rrca
        call setAyReg
        
        ; regVolumeA
        ld c, AY.regVolumeA
        ld a, (ayChA + dVol)
     .3 srl a
        call setAyReg
        
        ; regVolumeB
        inc c
        ld a, (ayChB + dVol)
    .3  srl a
        call setAyReg
        
        ; regVolumeC
        inc c
        ld a, (ayChC + dVol)
    .3  srl a
        call setAyReg
        
        jp justReturn


p_c8fb:  ; #c8fb
        ld a, (mixerValue)
        and (ix + 2)
        cp (ix + 2)
        ret Z
        
        ld a, (ix + 15)
        ld iyl, a
        ld a, (ix + 16)
        ld iyh, a
        
        ld a, (ix + 6)
        and a
        jr Z, .l_0
        cp #FF
        jr Z, .l_0
        dec (ix + 6)
.l_0:
        call p_c9a3
        bit 2, (iy + 9)
        jp NZ, p_c99c
        ld l, (ix + 13)
        ld h, (ix + 14)
        jp hl
        ; possible jumps:
        ; p_c92d, p_c94c, p_c96e, p_c967d

p_c92d:  ; #c92d
        ld a, (ix + 5)
        add a, (iy + 0)
        cp (iy + 4)
        jr NC, .l_0
        ld (ix + 5), a
        ret
.l_0:
        ld a, (iy + 4)
        ld (ix + 5), a
        ld hl, p_c94c
        ld (ix + 13), l
        ld (ix + 14), h
        ret


p_c94c:  ; #c94c
        ld a, (ix + 5)
        add a, (iy + 1)
        jp M, .l_0
        cp (iy + 2)
        jr C, .l_0
        ld (ix + 5), a
        ret
.l_0:
        ld a, (iy + 2)
        ld (ix + 5), a
        ld hl, p_c96e
        ld (ix + 13), l
        ld (ix + 14), h
        ret


p_c96e:  ; #c96e
        ld a, (ix + 6)
        and a
        ret NZ
        ld hl, p_c967d
        ld (ix + 13), l
        ld (ix + 14), h
        ret


p_c967d: ; #c967d
        ld a, (ix + 5)
        add a, (iy + 3)
        jp M, .l_0
        ld (ix + 5), a
        ret
.l_0:
        ld (ix + 5), 0
        ld a, (mixerValue)
        or (ix + 2)
        ld (mixerValue), a
        res 7, (ix + 17)
        ret

p_c99c:  ; #c99c
        ld a, (ix + 6)
        and a
        ret NZ
        jr p_c967d.l_0


p_c9a3:  ; # c9a3
        ld a, (ix + 7)
        and a
        jr Z, .l_0
        cp #FF
        ret Z
        dec (ix + 7)
        ret NZ
.l_0:
        ld l, (ix + 9)
        ld h, (ix + 10)
        ld c, (ix + 11)
        ld b, (ix + 12)
        add hl, bc
        ld (ix + 9), l
        ld (ix + 10), h
        dec (ix + 8)
        ret NZ
        ld a, (iy + 6)
        and a
        ret Z
        jp P, .l_1
        ld (ix + 7), #FF
        ret
.l_1:
        ld (ix + 8), a
        ld a, c
        cpl
        ld c, a
        ld a, b
        cpl
        ld b, a
        inc bc
        ld (ix + 11), c
        ld (ix + 12), b
        ret


; Why?
doNothing:  ; #c9e5
        ret

; Why?
justReturn:  ; #c9e6
        ret


; Writes value `a` to AY register `c`
; Used by p_c779.
setAyReg:  ; #c9e7
        push bc
        ld e, c
        ld bc, #FFFD
        out (c), e
        ld b, #BF
        out (c), a
        pop bc
        ret


; Unused?
p_c9f4:  ; #c9f4
        jp callPlayMenuMusic

; Unused?
p_c9f7:  ; #c9f7
        jp callAySoundFrame


; (some byte, external?)
p_c9fa:  ; #c9fa
        db 0

; ()
p_c9fb:  ; #c9fb
        dh C3 05 CA AF 32 FA C9 C3
        dh FE C7 F3 6F 5F 26 00 54
        dh 29 19 29 29 19 FD 21 D4
        dh C5 EB FD 19 FD 6E 0A FD
        dh 66 0B FD 4E 0C DD 21 42
        dh C7 CD 79 C7 DD CB 11 FE
        dh FB C9

; ()
p_ca2d:  ; #ca2d
        db 0

; > (0, 1)
p_ca2e:  ; #ca2e
        dh 6F 64 65 0D 0A 09

p_ca34: dw #646C
p_ca36: db #20  ; > 1
p_ca37: db #28  ; > 0
p_ca38: db #69  ; > #FF
p_ca39: db #78  ; > 1
p_ca3a: db #2B  ; > #FF

; ()
p_ca3b:  ; #ca3b
        dh 73

; > 0
p_ca3c:  ; #ca3c
        dh 70 74 63 6F 6C 29 08

; > (2, 3)
p_ca43:  ; #ca43
        dh 37 31 09 09 3B 73

p_ca49: dw #7465
p_ca4b: db #20  ; > 1
p_ca4c: db #63  ; > 0
p_ca4d: db #6F  ; > #FF
p_ca4e: db #6C  ; > 1
p_ca4f: db #6F  ; > #FF

p_ca50: db #75

; > 0
p_ca51:  ; #ca51
        dh 72 20 74 6F 20 77
        dh 10

; > (4, 5)
p_ca58: dh 69 74 65 0D 0A 09

p_ca5e: dw #6572
p_ca60: db #74  ; > 1
p_ca61: db #0D  ; > 0
p_ca62: db #0A  ; > #FF
p_ca63: db #0D  ; > 1
p_ca64: db #0A  ; > #FF

p_ca65: db #3B

; > 0
p_ca66:  ; #ca66
        dh 2D 2D 2D 2D 2D 2D

; 3 × 8 bytes
; > 0, 10, 20, 30, 40, 50, 60, 70
p_ca6c:  ; #ca6c
        dh 2D 2D 2D 2D 20 63 6F 69
        dh 6E 20 6A 75 6D 70 69 6E
        dh 67 20 2D 2D 2D 2D 2D 2D


; Initializes menu AY music
;   `a`: (0 or 1) something(?)
playMenuMusic:  ; #ca84
        push af
        call initAy
        pop af
        
        ld l, a
        add a, a
        add a, l
        add a, a
        ; `a` *= 6
        ld hl, p_c4cb
        add a, l
        ld l, a
        jr NC, .l_0
        inc h
.l_0:
        ; `hl`: p_c4cb + 6 * `a`
        
        ld e, (hl)
        inc hl
        ld d, (hl)
        inc hl
        ld (p_ca2e), de
        
        ld e, (hl)
        inc hl
        ld d, (hl)
        inc hl
        ld (p_ca43), de
        
        ld e, (hl)
        inc hl
        ld d, (hl)
        inc hl
        ld (p_ca58), de
        
        ; init with 0
        xor a
        ld (p_ca37), a
        ld (p_ca4c), a
        ld (p_ca61), a
        ld (p_ca3c), a
        ld (p_ca51), a
        ld (p_ca66), a
        
        ; init with #FF
        cpl
        ld (p_ca38), a
        ld (p_ca4d), a
        ld (p_ca62), a
        
        ; init with 1
        ld a, 1
        ld (p_ca36), a
        ld (p_ca4b), a
        ld (p_ca60), a
        ld (p_ca39), a
        ld (p_ca4e), a
        ld (p_ca63), a
        
        ; init with (0, 10, 20, …, 70)
        ld hl, p_ca6c
        ld bc, #030A  ; `b`= 3, `c`= 10
.l_1:
        xor a
.l_2:
        ld (hl), a
        inc hl
        add a, c
        ld (hl), a
        inc hl
        add a, c
        cp 80
        jr NZ, .l_2
        djnz .l_1
        
        ; init with some addr(?)
        ld hl, #C584
        ld (p_ca34), hl
        ld (p_ca49), hl
        ld (p_ca5e), hl
        
        ; init with #FF
        ld a, #FF
        ld (p_ca3a), a
        ld (p_ca4f), a
        ld (p_ca64), a
        ld (p_c9fa), a
        
        ret


; Called in interrupts
aySoundFrame:  ; #cb0c
        call setAyValues
        ld a, (p_c9fa)
        and a
        ret Z
        
        ld a, (p_ca3a)
        ld hl, p_ca4f
        or (hl)
        ld hl, p_ca64
        or (hl)
        ld (p_c9fa), a
        jr NZ, .l_0
        xor a
        ld (p_c9fa), a
        ld a, (mixerValue)
        and #3F
        cp #3F
        ret Z
        ld a, #01
        ld (p_c9fa), a
        ret
.l_0:
        ld iy, p_ca2d
        ld ix, ayChA
        call .l_1
        ld iy, #CA42
        ld ix, ayChB
        call .l_1
        ld iy, #CA57
        ld ix, ayChC
.l_1:
        call p_cc95
        ld a, (iy + 11)
        and a
        jr Z, .l_10
.l_2:
        dec (iy + 9)
        jr Z, .l_3
        ld a, (iy + 3)
        ld (iy + 5), a
        ld a, (iy + 4)
        ld (iy + 6), a
        ld (iy + 11), #00
        jr .l_10
.l_3:
        ld (iy + 9), #01
        ld l, (iy + 1)
        ld h, (iy + 2)
.l_4:
        ld a, (hl)
        cp #80
        jr C, .l_9
        cp #FE
        jr NZ, .l_5
        inc hl
        ld a, (hl)
        ld (iy + 10), a
        inc hl
        jp .l_4
.l_5:
        cp #FF
        jr NZ, .l_6
        xor a
        ld (iy + 13), a
        ret
.l_6:
        cp #C0
        jr NC, .l_7
        and #1F
        ld (iy + 9), a
        inc hl
        jp .l_4
.l_7:
        and #07
        add a, (iy)
        ld de, #CA6C
        add a, e
        ld e, a
        jr NC, .l_8
        inc d
.l_8:
        inc hl
        ldi
        jp .l_4
.l_9:
        ld (iy + 11), #00
        inc hl
        ld (iy + 1), l
        ld (iy + 2), h
        ld c, a
        ld b, #00
        ld hl, #C520
        add hl, bc
        ld e, (hl)
        ld hl, #C53E
        add hl, bc
        ld d, (hl)
        ld (iy + 3), e
        ld (iy + 4), d
        jr .l_11
.l_10:
        ld e, (iy + 5)
        ld d, (iy + 6)
.l_11:
        dec (iy + 12)
        jr Z, .l_12
        ld a, (de)
        cp #80
        call NC, p_cc5b
        ld (iy + 5), e
        ld (iy + 6), d
        ret
.l_12:
        ld a, (de)
        cp #80
        jr C, .l_13
        call p_cc5b
        ld a, (iy + 11)
        and a
        jr Z, .l_12
        jp .l_2
.l_13:
        cp #7F
        jr Z, .l_16
        cp #7E
        jr NZ, .l_14
        inc de
        ld a, (de)
        ld l, a
        inc de
        ld a, (de)
        ld h, a
        jp .l_15
.l_14:
        add a, (iy + 10)
        add a, #0C
        ld (iy + 14), a
        ld hl, p_c697
        add a, a
        ld c, a
        ld b, #00
        add hl, bc
        ld a, (hl)
        inc hl
        ld h, (hl)
        ld l, a
.l_15:
        ld a, (iy + 15)
        or #C0
        ld (iy + 20), a
        inc de
        ld a, (de)
        inc de
        ld (iy + 12), a
        ld c, a
        ld (iy + 5), e
        ld (iy + 6), d
        ld e, (iy + 7)
        ld a, (iy + 8)
        ld iyh, a
        ld iyl, e
        bit 7, (ix + 17)
        ret NZ
        jp p_c779
.l_16:
        inc de
        ld a, (de)
        inc de
        ld (iy + 12), a
        ld (iy + 5), e
        ld (iy + 6), d
        ret


p_cc5b:  ; #cc5b
        ld a, (de)
        cp #88
        jr NC, .l_0
        and #07
        add a, (iy)
        ld c, a
        ld b, #00
        ld hl, #CA6C
        add hl, bc
        ld c, (hl)
        ld hl, #C584
        add hl, bc
        ld (iy + 7), l
        ld (iy + 8), h
        inc de
        ret
.l_0:
        cp #FF
        jr NZ, .l_1
        ld (iy + 11), #FF
        ret
.l_1:
        cp #C0
        jr NC, .l_2
        and #0F
        ld (iy + 15), a
        inc de
        ret
.l_2:
        inc de
        cp #C2
        ret Z
        inc de
        inc de
        inc de
        ret


p_cc95:  ; #cc95
        bit 7, (ix + 17)
        ret NZ
        ld a, (iy + 20)
        bit 7, a
        ret Z
        and #3F
        jr NZ, .l_0
        res 7, (iy + 20)
        ret
.l_0:
        ld d, #07
        bit 6, (iy + 20)
        jr NZ, .l_2
        dec (iy + 18)
        ret NZ
        dec (iy + 19)
        jp Z, .l_2
        ld l, (iy + 16)
        ld h, (iy + 17)
        inc l
        ld (iy + 16), l
        jp NZ, .l_1
        inc h
        ld (iy + 17), h
.l_1:
        ld a, (hl)
        and d
        ld (iy + 18), a
        ld a, (hl)
        rrca
        rrca
        rrca
        and #1F
        add a, (iy + 14)
        jp .l_4
.l_2:
        ld hl, #BE54
        ld a, (iy + 20)
        add a, a
        add a, a
        add a, a
        ld e, a
        add hl, de
        bit 7, (hl)
        jr NZ, .l_3
        bit 6, (iy + 20)
        jr NZ, .l_3
        ld (iy + 19), #01
        ret
.l_3:
        res 6, (iy + 20)
        ld a, (hl)
        rrca
        rrca
        rrca
        and d
        ld (iy + 18), a
        ld a, (hl)
        and d
        inc a
        ld (iy + 19), a
        ld (iy + 16), l
        ld (iy + 17), h
        ld a, (iy + 14)
.l_4:
        add a, a
        ld hl, p_c697
        add a, l
        ld l, a
        jr NC, .l_5
        inc h
.l_5:
        ld a, (hl)
        ld (ix + 3), a
        inc hl
        ld a, (hl)
        ld (ix + 4), a
        ret


; Initializes an AY sound effect
;   `a`: sound index (0..14)
playAySound:  ; #cd25
        push hl, de, bc, ix, iy
        
        ld e, a
        ld l, a
        ld h, 0
    .2  add hl, hl
        ld c, l
        ld b, h
        add hl, hl
        add hl, bc
        ld c, a
        ld b, 0
        add hl, bc
        ; `hl`: a * 13
        ld bc, aySounds
        add hl, bc
        push hl
        pop iy
        ; `iy`: sound effect addr
        
        ld a, (p_cd77)
        inc a
        cp 3
        jp C, .l_0
        xor a
.l_0:
        ld (p_cd77), a
        
        ld ix, ayChA
        and a
        jp Z, .l_1
        ld ix, ayChB
        cp 1
        jp Z, .l_1
        ld ix, ayChC
.l_1:
        ld l, (iy + 10)
        ld h, (iy + 11)
        ld c, (iy + 12)
        call p_c779
        
        pop iy, ix, bc, de, hl
        ret


; (some counter (0..2)?)
p_cd77:  ; #cd77
        db 0

          ENT


    ENDMODULE
